with popularity as (with slength as (select * , least(datediff(Checkout,Checkin), datediff(now(), checkin)) StayLength from lab7_reservations where (datediff(now(), Checkout) < 180) and datediff(now(), CheckIn) > 0) select Room, ROUND(sum(StayLength) / 180, 2) Popularity from slength group by Room), available as (with rs as (select Room, Checkin,Checkout from lab7_reservations where datediff(Checkout, now()) > 0), gaps as (select r1.Room, r1.Checkout, r2.CheckIn from rs r1 join rs r2 on r1.Checkout < r2.CheckIn and r1.Room = r2.Room where datediff(r1.CheckIn, r2.Checkout) <> 0) select Room, min(Checkout) nextAvailable  from gaps group by Room), recent as (select completed.Room Room, completed.checkout CheckoutDay, datediff(lab7_reservations.Checkout, lab7_reservations.CheckIn) LengtOfMostRecentStay from (select Room, max(Checkout) checkout from lab7_reservations where datediff(now(), Checkout) > 0 group by Room) completed join lab7_reservations on lab7_reservations.Room = completed.Room and completed.checkout = lab7_reservations.Checkout) select available.Room, NextAvailable, Popularity, CheckoutDay MostRecentCheckout, LengtOfMostRecentStay from available join popularity on available.Room = popularity.Room join recent on recent.Room = available.Room;